<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¸å®‰æ¨¡æ‹Ÿäº¤æ˜“ - MACD ç­–ç•¥æ§åˆ¶å°</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; color: #333; line-height: 1.6; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        header { 
            background: white; 
            padding: 15px 25px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        h1 { color: #1a2a3a; font-size: 22px; display: flex; align-items: center; gap: 10px; }
        
        .header-controls { display: flex; gap: 15px; align-items: center; }
        
        .btn { 
            padding: 8px 16px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px; 
            transition: all 0.2s; 
            font-weight: 600; 
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn-primary { background: #00b894; color: white; }
        .btn-primary:hover { background: #00a383; transform: translateY(-1px); }
        .btn-danger { background: #ff7675; color: white; }
        .btn-danger:hover { background: #ee6665; transform: translateY(-1px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .status-indicator { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .status-running { background: #00b894; box-shadow: 0 0 8px #00b894; animation: pulse 2s infinite; }
        .status-stopped { background: #b2bec3; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        
        .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card-title { font-size: 15px; font-weight: 700; color: #2d3436; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; border-bottom: 1px solid #f1f2f6; padding-bottom: 10px; }
        
        .metric { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; }
        .metric-label { color: #636e72; font-size: 13px; }
        .metric-value { font-size: 16px; font-weight: 700; color: #2d3436; }
        .positive { color: #00b894; }
        .negative { color: #ff7675; }
        
        .price-card { text-align: center; padding: 15px; border-radius: 8px; background: #fff; border: 1px solid #e1e4e8; transition: all 0.3s; }
        .price-card:hover { border-color: #3498db; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .price-symbol { font-weight: 800; font-size: 14px; color: #2d3436; margin-bottom: 5px; }
        .price-value { font-size: 20px; font-weight: 700; font-family: 'Courier New', Courier, monospace; }
        
        .tabs { display: flex; border-bottom: 1px solid #dfe6e9; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; background: none; border: none; cursor: pointer; font-size: 14px; color: #636e72; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-btn.active { color: #0984e3; border-bottom-color: #0984e3; font-weight: 700; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .chart-container { height: 350px; width: 100%; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 12px; background: #f8f9fa; color: #636e72; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid #f1f2f6; }
        
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; }
        .badge-buy { background: #e1f5fe; color: #0288d1; }
        .badge-sell { background: #fff3e0; color: #f57c00; }
        .badge-golden { background: #e8f5e9; color: #2e7d32; }
        .badge-dead { background: #ffebee; color: #c62828; }
        
        .positions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .position-card { padding: 15px; border-radius: 8px; border-left: 4px solid #0984e3; background: #f8f9fa; }
        .position-card.long { border-left-color: #00b894; }
        .position-card.short { border-left-color: #ff7675; }
        
        .loading { text-align: center; padding: 30px; color: #b2bec3; font-style: italic; }
        
        .network-status { font-size: 12px; color: #636e72; display: flex; align-items: center; gap: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ¤– å¸å®‰æ¨¡æ‹Ÿäº¤æ˜“ - MACD ç­–ç•¥æ§åˆ¶å°</h1>
            <div class="header-controls">
                <div class="network-status" id="networkStatus">
                    <span class="status-indicator status-stopped"></span>
                    <span>ç½‘ç»œå»¶è¿Ÿ: --ms</span>
                </div>
                <button class="btn btn-primary" id="startBtn" onclick="startStrategy()">â–¶ å¯åŠ¨ç­–ç•¥</button>
                <button class="btn btn-danger" id="stopBtn" onclick="stopStrategy()" disabled>â–  åœæ­¢ç­–ç•¥</button>
            </div>
        </header>

        <!-- å®æ—¶ä»·æ ¼æ„ŸçŸ¥æ¡† -->
        <div class="grid-4" id="priceOverview">
            <div class="price-card" style="grid-column: span 4;"><div class="price-symbol">BTC/USDT (ç°è´§ç›‘æ§)</div><div class="price-value" id="price-BTCUSDT">--</div></div>
        </div>

        <div class="grid-3">
            <div class="card">
                <div class="card-title">ğŸ’° è´¦æˆ·èµ„é‡‘</div>
                <div class="metric"><span class="metric-label">åˆå§‹èµ„é‡‘</span><span class="metric-value">$<span id="initialCapital">0</span></span></div>
                <div class="metric"><span class="metric-label">å½“å‰æƒç›Š</span><span class="metric-value">$<span id="currentCapital">0</span></span></div>
                <div class="metric"><span class="metric-label">å¯ç”¨ä½™é¢</span><span class="metric-value">$<span id="availableBalance">0</span></span></div>
                <div class="metric"><span class="metric-label">æ€»ç›ˆäº</span><span class="metric-value" id="totalProfitLoss">$0</span></div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ“Š äº¤æ˜“ç»Ÿè®¡</div>
                <div class="metric"><span class="metric-label">æ€»äº¤æ˜“æ•°</span><span class="metric-value" id="totalTrades">0</span></div>
                <div class="metric"><span class="metric-label">ç›ˆåˆ©äº¤æ˜“</span><span class="metric-value positive" id="winningTrades">0</span></div>
                <div class="metric"><span class="metric-label">äºæŸäº¤æ˜“</span><span class="metric-value negative" id="losingTrades">0</span></div>
                <div class="metric"><span class="metric-label">èƒœç‡</span><span class="metric-value" id="winRate">0%</span></div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡</div>
                <div class="metric"><span class="metric-label">æ”¶ç›Šç‡ (ROI)</span><span class="metric-value" id="roi">0%</span></div>
                <div class="metric"><span class="metric-label">æœ€å¤§å›æ’¤</span><span class="metric-value" id="maxDrawdown">0%</span></div>
                <div class="metric"><span class="metric-label">æ´»è·ƒæŒä»“</span><span class="metric-value" id="activePositions">0</span></div>
                <div class="metric"><span class="metric-label">å¤æ™®æ¯”ç‡</span><span class="metric-value" id="sharpeRatio">0</span></div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 20px;">
            <div class="card-title">ğŸ“‰ èµ„é‡‘æ›²çº¿</div>
            <div class="chart-container" id="equityChart"></div>
        </div>

        <div class="card">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('positions')">ğŸ“ æ´»è·ƒæŒä»“</button>
                <button class="tab-btn" onclick="switchTab('trades')">âœ… å·²å¹³ä»“äº¤æ˜“</button>
                <button class="tab-btn" onclick="switchTab('signals')">ğŸ¯ MACDä¿¡å·</button>
                <button class="tab-btn" onclick="switchTab('klines')">ğŸ•¯ï¸ Kçº¿å›¾è¡¨</button>
            </div>

            <div id="positions" class="tab-content active">
                <div id="positionsContainer" class="positions-grid"><div class="loading">æš‚æ— æ´»è·ƒæŒä»“</div></div>
                <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee;">
                    <h4 style="margin-bottom: 15px; font-size: 14px;">ğŸ® æ‰‹åŠ¨äº¤æ˜“æ§åˆ¶</h4>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="symbolSelect" style="padding: 8px 12px; border-radius: 6px; border: 1px solid #dfe6e9; outline: none;">
                            <option value="BTCUSDT">BTC/USDT (åˆçº¦)</option>
                        </select>
                        <button class="btn btn-primary" onclick="manualBuy()">ğŸŸ¢ å¸‚ä»·ä¹°å…¥</button>
                        <button class="btn btn-danger" onclick="manualSell()">ğŸ”´ å¸‚ä»·å–å‡º</button>
                    </div>
                </div>
            </div>

            <div id="trades" class="tab-content">
                <table class="table">
                    <thead><tr><th>ID</th><th>äº¤æ˜“å¯¹</th><th>æ–¹å‘</th><th>å…¥åœºä»·</th><th>æ•°é‡</th><th>å‡ºåœºä»·</th><th>ç›ˆäº</th><th>ç›ˆäº%</th><th>ä¿¡å·</th><th>æ—¶é—´</th></tr></thead>
                    <tbody id="tradesBody"><tr><td colspan="10" class="loading">æš‚æ— äº¤æ˜“æ•°æ®</td></tr></tbody>
                </table>
            </div>

            <div id="signals" class="tab-content">
                <div id="signalsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;">
                    <div class="loading">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <div id="klines" class="tab-content">
                <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <label style="font-size: 13px; color: #636e72;">é€‰æ‹©äº¤æ˜“å¯¹:</label>
                    <select id="klineSymbolSelect" onchange="updateKlineChart()" style="padding: 6px 12px; border-radius: 6px; border: 1px solid #dfe6e9;">
                        <option value="BTCUSDT">BTC/USDT</option>
                    </select>
                </div>
                <div class="chart-container" id="klineChart"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let equityChart, klineChart;
        let autoRefreshInterval;
        let lastPrices = {};

        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            updateDashboard();
            autoRefreshInterval = setInterval(updateDashboard, 2000);
        });

        function initCharts() {
            equityChart = echarts.init(document.getElementById('equityChart'));
            klineChart = echarts.init(document.getElementById('klineChart'));
            window.addEventListener('resize', () => { equityChart.resize(); klineChart.resize(); });
        }

        async function updateDashboard() {
            try {
                const response = await fetch(`${API_BASE}/summary`);
                const data = await response.json();

                updateStats(data.stats);
                updatePositions(data.active_positions);
                updateNetworkStatus(data.network_latency);
                updateEquityChart(data.equity_curve);
                updateSignals(data.latest_signals);
                updatePriceOverview(data.latest_signals);
                
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');
                if (data.strategy.enabled) {
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                } else {
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                }
            } catch (error) {
                console.error('æ›´æ–°ä»ªè¡¨æ¿å¤±è´¥:', error);
            }
        }

        function updatePriceOverview(signals) {
            if (!signals) return;
            Object.entries(signals).forEach(([symbol, sig]) => {
                const el = document.getElementById(`price-${symbol}`);
                if (el) {
                    const oldPrice = lastPrices[symbol] || 0;
                    const newPrice = sig.close;
                    el.textContent = `$${newPrice.toFixed(2)}`;
                    
                    if (newPrice > oldPrice) {
                        el.className = 'price-value positive';
                    } else if (newPrice < oldPrice) {
                        el.className = 'price-value negative';
                    }
                    lastPrices[symbol] = newPrice;
                }
            });
        }

        function updateStats(stats) {
            document.getElementById('initialCapital').textContent = stats.initial_capital.toFixed(2);
            document.getElementById('currentCapital').textContent = stats.current_capital.toFixed(2);
            document.getElementById('availableBalance').textContent = stats.available_balance.toFixed(2);
            const profitLoss = stats.current_capital - stats.initial_capital;
            const profitEl = document.getElementById('totalProfitLoss');
            profitEl.textContent = `$${profitLoss.toFixed(2)}`;
            profitEl.className = 'metric-value ' + (profitLoss >= 0 ? 'positive' : 'negative');
            document.getElementById('totalTrades').textContent = stats.total_trades;
            document.getElementById('winningTrades').textContent = stats.winning_trades;
            document.getElementById('losingTrades').textContent = stats.losing_trades;
            document.getElementById('winRate').textContent = (stats.win_rate * 100).toFixed(2) + '%';
            document.getElementById('roi').textContent = stats.roi.toFixed(2) + '%';
            document.getElementById('maxDrawdown').textContent = (stats.max_drawdown * 100).toFixed(2) + '%';
            document.getElementById('sharpeRatio').textContent = stats.sharpe_ratio.toFixed(2);
        }

        function updatePositions(positions) {
            document.getElementById('activePositions').textContent = positions.count;
            const container = document.getElementById('positionsContainer');
            if (positions.count === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— æ´»è·ƒæŒä»“</div>';
                return;
            }
            container.innerHTML = positions.positions.map(pos => `
                <div class="position-card ${pos.side === 'BUY' ? 'long' : 'short'}">
                    <div style="font-weight: 800; font-size: 16px; margin-bottom: 10px;">${pos.symbol}</div>
                    <div style="font-size: 12px; color: #636e72;">
                        <div>æ–¹å‘: <strong class="${pos.side === 'BUY' ? 'positive' : 'negative'}">${pos.side === 'BUY' ? 'å¤šå¤´ ğŸŸ¢' : 'ç©ºå¤´ ğŸ”´'}</strong></div>
                        <div>å…¥åœºä»·: $${pos.entry_price.toFixed(2)}</div>
                        <div>æ•°é‡: ${pos.entry_quantity.toFixed(6)}</div>
                        <div>æ—¶é—´: ${new Date(pos.entry_time).toLocaleTimeString()}</div>
                        <button class="btn btn-danger" onclick="manualClosePosition('${pos.symbol}')" style="width: 100%; margin-top: 12px; padding: 6px;">ç«‹å³å¹³ä»“</button>
                    </div>
                </div>
            `).join('');
        }

        function updateNetworkStatus(latency) {
            const statusEl = document.getElementById('networkStatus');
            const indicator = statusEl.querySelector('.status-indicator');
            const text = statusEl.querySelector('span:last-child');
            if (latency.status === 'OK') {
                indicator.className = 'status-indicator status-running';
                text.textContent = `ç½‘ç»œå»¶è¿Ÿ: ${latency.latency_ms.toFixed(0)}ms`;
                text.className = latency.latency_ms < 200 ? 'positive' : (latency.latency_ms < 500 ? '' : 'negative');
            } else {
                indicator.className = 'status-indicator status-stopped';
                text.textContent = 'ç½‘ç»œå¼‚å¸¸';
            }
        }

        function updateEquityChart(curve) {
            if (!curve || curve.length === 0) return;
            const times = curve.map(d => new Date(d.timestamp).toLocaleTimeString());
            const equities = curve.map(d => d.equity);
            equityChart.setOption({
                tooltip: { trigger: 'axis' },
                xAxis: { type: 'category', data: times, boundaryGap: false },
                yAxis: { type: 'value', scale: true },
                series: [{ name: 'æ€»æƒç›Š', data: equities, type: 'line', smooth: true, areaStyle: { opacity: 0.1 }, itemStyle: { color: '#0984e3' } }],
                grid: { left: '5%', right: '5%', bottom: '5%', top: '10%', containLabel: true }
            });
        }

        function updateSignals(signals) {
            const container = document.getElementById('signalsContainer');
            if (!signals || Object.keys(signals).length === 0) {
                container.innerHTML = '<div class="loading">æš‚æ— ä¿¡å·æ•°æ®</div>';
                return;
            }
            container.innerHTML = Object.entries(signals).map(([symbol, sig]) => `
                <div class="card">
                    <div style="font-weight: 800; margin-bottom: 12px; color: #2d3436;">${symbol}</div>
                    <div class="metric"><span class="metric-label">å½“å‰ä»·æ ¼</span><span class="metric-value">$${sig.close.toFixed(2)}</span></div>
                    <div class="metric"><span class="metric-label">MACD</span><span class="metric-value">${sig.macd.toFixed(6)}</span></div>
                    <div class="metric"><span class="metric-label">ä¿¡å·çº¿</span><span class="metric-value">${sig.signal.toFixed(6)}</span></div>
                    <div class="metric"><span class="metric-label">æŸ±çŠ¶å›¾</span><span class="metric-value">${sig.histogram.toFixed(6)}</span></div>
                    <div class="metric">
                        <span class="metric-label">å½“å‰ä¿¡å·</span>
                        <span class="badge ${sig.signal_type === 'GOLDEN_CROSS' ? 'badge-golden' : sig.signal_type === 'DEAD_CROSS' ? 'badge-dead' : ''}">
                            ${sig.signal_type === 'GOLDEN_CROSS' ? 'ğŸŸ¢ é‡‘å‰' : sig.signal_type === 'DEAD_CROSS' ? 'ğŸ”´ æ­»å‰' : 'â€” æ— '}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if (event) event.target.classList.add('active');
            if (tabName === 'trades') updateTradesTable();
            if (tabName === 'klines') updateKlineChart();
        }

        async function updateTradesTable() {
            try {
                const response = await fetch(`${API_BASE}/trades/closed?limit=20`);
                const data = await response.json();
                const tbody = document.getElementById('tradesBody');
                if (!data.trades || data.trades.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #999;">æš‚æ— äº¤æ˜“æ•°æ®</td></tr>';
                    return;
                }
                tbody.innerHTML = data.trades.map(t => `
                    <tr>
                        <td>${t.trade_id.substring(0,8)}</td>
                        <td><strong>${t.symbol}</strong></td>
                        <td><span class="badge ${t.side === 'BUY' ? 'badge-buy' : 'badge-sell'}">${t.side === 'BUY' ? 'ä¹°å…¥' : 'å–å‡º'}</span></td>
                        <td>$${t.entry_price.toFixed(2)}</td>
                        <td>${t.entry_quantity.toFixed(6)}</td>
                        <td>$${t.exit_price.toFixed(2)}</td>
                        <td class="${t.profit_loss >= 0 ? 'positive' : 'negative'}">$${t.profit_loss.toFixed(2)}</td>
                        <td class="${t.profit_loss_pct >= 0 ? 'positive' : 'negative'}">${t.profit_loss_pct.toFixed(2)}%</td>
                        <td><span class="badge ${t.macd_signal === 'GOLDEN_CROSS' ? 'badge-golden' : 'badge-dead'}">${t.macd_signal === 'GOLDEN_CROSS' ? 'é‡‘å‰' : 'æ­»å‰'}</span></td>
                        <td>${new Date(t.exit_time).toLocaleString()}</td>
                    </tr>
                `).join('');
            } catch (e) { console.error(e); }
        }

        async function updateKlineChart() {
            const symbol = document.getElementById('klineSymbolSelect').value;
            try {
                const response = await fetch(`${API_BASE}/orders/klines/${symbol}?limit=60`);
                const data = await response.json();
                if (!data.klines) return;
                const times = data.klines.map(k => new Date(k.open_time).toLocaleTimeString());
                const values = data.klines.map(k => [k.open, k.close, k.low, k.high]);
                klineChart.setOption({
                    title: { text: `${symbol} å®æ—¶Kçº¿`, left: 'center', textStyle: { fontSize: 14 } },
                    tooltip: { trigger: 'axis', axisPointer: { type: 'cross' } },
                    xAxis: { data: times },
                    yAxis: { scale: true },
                    series: [{ type: 'candlestick', data: values, itemStyle: { color: '#00b894', color0: '#ff7675', borderColor: '#00b894', borderColor0: '#ff7675' } }],
                    grid: { left: '5%', right: '5%', bottom: '10%', containLabel: true }
                });
            } catch (e) { console.error(e); }
        }

        async function startStrategy() {
            try {
                await fetch(`${API_BASE}/strategy/start`, { method: 'POST' });
                updateDashboard();
            } catch (e) { alert('å¯åŠ¨å¤±è´¥'); }
        }

        async function stopStrategy() {
            if (!confirm('ç¡®å®šåœæ­¢ç­–ç•¥å¹¶å¹³ä»“å—ï¼Ÿ')) return;
            try {
                await fetch(`${API_BASE}/strategy/stop`, { method: 'POST' });
                updateDashboard();
            } catch (e) { alert('åœæ­¢å¤±è´¥'); }
        }

        async function manualBuy() {
            const symbol = document.getElementById('symbolSelect').value;
            try {
                const res = await fetch(`${API_BASE}/manual/position/${symbol}/open`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ side: 'BUY' })
                });
                const data = await res.json();
                if (data.status === 'success') alert('ä¹°å…¥æˆåŠŸ');
                else alert('ä¹°å…¥å¤±è´¥: ' + data.error);
                updateDashboard();
            } catch (e) { alert('è¯·æ±‚å¤±è´¥'); }
        }

        async function manualSell() {
            const symbol = document.getElementById('symbolSelect').value;
            try {
                const res = await fetch(`${API_BASE}/manual/position/${symbol}/open`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ side: 'SELL' })
                });
                const data = await res.json();
                if (data.status === 'success') alert('å–å‡ºæˆåŠŸ');
                else alert('å–å‡ºå¤±è´¥: ' + data.error);
                updateDashboard();
            } catch (e) { alert('è¯·æ±‚å¤±è´¥'); }
        }

        async function manualClosePosition(symbol) {
            try {
                const res = await fetch(`${API_BASE}/manual/position/${symbol}/close`, { method: 'POST' });
                const data = await res.json();
                if (data.status === 'success') alert('å¹³ä»“æˆåŠŸ');
                updateDashboard();
            } catch (e) { alert('è¯·æ±‚å¤±è´¥'); }
        }
    </script>
</body>
</html>
